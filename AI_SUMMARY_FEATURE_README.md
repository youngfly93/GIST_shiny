# AI聊天记录总结功能说明

## 功能概述

新增的AI聊天记录总结功能允许用户对多次基因表达分析的结果进行综合总结，生成专业的分析报告。这个功能通过累积保存AI分析结果，然后让AI对所有历史记录进行综合分析，生成更有价值的insights。

## 核心特性

### 1. 自动保存分析结果
- 每次AI分析完成后，系统会自动将分析结果保存到 `ai_analysis_history.md` 文件中
- 保存的信息包括：基因名称、分析类型、时间戳、完整的AI分析结果
- 使用Markdown格式，便于阅读和后续处理

### 2. 生成综合总结报告 
- 点击 📄 Summary按钮，系统会读取所有历史分析记录
- 将累积的分析内容发送给AI进行综合总结
- AI会从5个维度进行分析：
  - 分析概览：涉及的基因和分析类型
  - 关键发现：各基因的生物学意义和表达特征
  - 临床意义：整体临床相关性和应用价值
  - 生物学洞察：从多个分析中得出的规律和趋势
  - 研究建议：基于分析结果的后续研究方向

### 3. 清空历史记录
- 点击 🗑️ Clear按钮可以清空所有历史记录
- 删除 `ai_analysis_history.md` 文件，重新开始记录

## 使用流程

### 步骤1：进行基因表达分析
1. 在任意分析模块中选择基因和分析类型
2. 点击"Visualize"生成图表
3. AI会自动分析图表并在聊天窗口显示结果
4. 分析结果会自动保存到历史文件中

### 步骤2：累积多次分析
- 重复步骤1，分析不同的基因或使用不同的分析类型
- 每次分析都会累积保存，建立丰富的分析历史

### 步骤3：生成综合报告
1. 点击AI聊天窗口右上角的 📄 Summary按钮
2. 系统显示"AI正在分析中..."加载状态
3. AI会对所有历史记录进行综合分析
4. 生成的总结报告会在聊天窗口中显示
5. 同时会保存为独立的markdown文件，便于后续查看

## 技术实现

### 文件结构
```
ai_analysis_history.md              # 分析历史累积文件
ai_summary_report_YYYYMMDD_HHMMSS.md  # 生成的总结报告文件
```

### 新增UI组件
- 📄 Summary按钮：生成综合分析报告
- 🗑️ Clear按钮：清空分析历史
- 绿色和红色的配色方案，符合功能含义

### API集成
- 使用OpenRouter API和Google Gemini 2.5 Flash模型
- 支持长文本分析（最高2000 tokens输出）
- 自动处理网络超时和错误情况

## 示例输出

生成的总结报告包含以下结构：

```markdown
# GIST AI 综合分析报告

**生成时间**: 2025-06-23 20:37:04
**分析历史长度**: 631 字符

---

## GIST（胃肠道间质瘤）基因表达分析历史记录综合总结报告

### 1. 分析概览
- 本次分析历史记录共涉及3个核心基因：TP53、MCM7、MKI67
- 涉及3种分析类型：性别差异表达分析、基因相关性分析、药物反应分析

### 2. 关键发现
- **TP53**: 作为"基因组守护者"，在GIST中发挥重要肿瘤抑制功能...
- **MCM7**: DNA复制相关基因，高表达可能与肿瘤增殖活性相关...
- **MKI67**: 经典增殖标志物，与GIST恶性程度密切相关...

### 3. 临床意义
- 预后评估、潜在生物标志物、个体化治疗指导...

### 4. 生物学洞察
- 增殖活性在GIST中的核心地位...
- 肿瘤抑制基因TP53的复杂性...

### 5. 研究建议
- TP53性别差异的机制研究...
- MCM7作为侵袭性标志物的验证...
- 多基因联合生物标志物开发...
```

## 注意事项

1. **文件权限**：确保应用对工作目录有写入权限
2. **网络连接**：Summary功能需要网络连接到OpenRouter API
3. **文件编码**：所有文件使用UTF-8编码，支持中文内容
4. **存储空间**：长期使用需要定期清理历史文件
5. **API配额**：大量使用可能消耗API配额，建议合理使用

## 错误处理

系统包含完善的错误处理机制：
- 网络连接失败时显示友好错误消息
- API调用超时时自动重试
- 文件读写错误时不影响主要功能
- 所有错误都记录在控制台，便于调试

## 维护说明

- 历史文件会不断增长，建议定期使用Clear功能清理
- 可以手动查看和编辑 `ai_analysis_history.md` 文件
- 生成的报告文件可以用于研究记录和文档整理